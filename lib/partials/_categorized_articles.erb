<%
base_path = "source#{current_page.url}"
categories = []

# Categorized articles
(current_page.data.categories || Dir.glob("#{base_path}*").select {|f| File.directory? f }).each do |category|

  sub_category_dir = File.basename(category)
  sub_category_index = "#{base_path}#{sub_category_dir}/index.md"
  category_title = sub_category_dir.capitalize
  category_meta = File.exists?(sub_category_index) ? YAML.load(File.read(sub_category_index)) : {}

  articles = []
  (category_meta['featured'] || Dir.glob("#{base_path}#{sub_category_dir}/*.md")).each do |article|
    article_filename = File.basename(article, '.md')
    article_contents = File.read "#{base_path}#{sub_category_dir}/#{article_filename}.md"
    url = "#{current_page.url}#{sub_category_dir}/#{article_filename}".gsub(/index$/, '')

    if (yaml = YAML.load article_contents)
      meta = yaml.merge({ 'url' => url })
      unless article_filename == 'index'
        articles << meta unless meta['deprecated']
      else
        category_title = meta['title'] if meta['title']
      end
    end
  end

  categories << {
    :url => "#{current_page.url}#{sub_category_dir}/",
    :title => category_title,
    :articles => articles,
    :sub_category_dir => sub_category_dir,
    :description => category_meta['description']
  } unless articles.empty?
end
%>

<% if !categories.empty? %>
  <section class="primary some-space">
    <div class="container">
      <% categories.each do |category| %>
        <div class="row-content">
          <div class="col-sm-12">
            <h2 class="h3"><%= category[:title] %></h2>
            <p><small><%= category[:description] %></small></p>
            <ul class="list-group article-list">
              <% category[:articles].each_with_index do |article, index| %>
                <li class="list-group-item library-article-item"><h3 class="h5"><a href="<%= article['url'] %>"><%= article['title'] %></a></h3></li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>
    </div>
  </section>
<% end %>

