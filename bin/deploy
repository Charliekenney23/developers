#!/usr/bin/env bash

version=""
version_regex="[0-9]+\.[0-9]+\.[0-9]"

help_text () {
  echo
  echo "Usage: deploy VERSION"
  echo
}

# check for required version to deploy
if [ -z ${1+x} ]; then
  help_text
  echo "Error: VERSION is required"
  exit 1
fi

if [[ "$1" =~ ^${version_regex}$ ]]; then
  version="${1}"
else
  help_text
  echo "Error: VERSION must be a valid semantic version (major.minor.patch)"
  exit 1
fi

# only run without prompting in CI
if [ "$CI" != "true" ]; then
  echo
  echo "The following changes are about to be made:"
  echo "  - the development branch will be checked out"
  echo "  - a new release branch for ${version} will be created at release-${version}"
  echo "  - the version will be updated to ${version} in openapi.yaml"
  echo "  - these changes will be commited and tagged ${version}"
  echo
  read -p "Do you want to continue? " -n 1 -r
  echo

  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# if we have made it this far, we are ready to make changes
echo "Deploying version ${version}"

echo "Checking out development branch"
git checkout development

# ensure no local changes to openapi.yaml
git diff-index --quiet HEAD -- openapi.yaml

exit_status=$?
if [ $exit_status -ne 0 ]; then
  echo
  echo "Error: Local changes have been made to openapi.yaml."
  echo "       Please commit those changes before proceeding."
  exit 1
fi

echo "Creating a release branch release-${version}"
git checkout -b "release-${version}"

echo "Updating openapi.yaml with the new version number"
sed -ie -E -- "s|version: ${version_regex}|version: ${version}|" openapi.yaml

echo "Committing the version bump"
git add --all
git commit -m "Bump version to ${version}"

echo "Tagging the version commit with the version number"
git tag ${version}
