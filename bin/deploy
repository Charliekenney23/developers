#!/usr/bin/env bash

help_text () {
  echo
  echo "Usage: deploy VERSION"
  echo
}

# check for required version to deploy
if [ -z ${1+x} ]; then
  help_text
  echo "Error: VERSION is required"
  exit 1
fi

# only run without prompting in CI
if [ "$CI" != "true" ]; then
  echo
  echo "The following changes are about to be made:"
  echo "  - the development branch will be checked out"
  echo "  - a new release branch for ${1} will be created at release-${1}"
  echo "  - the version will be updated to ${1} in openapi.yaml"
  echo "  - these changes will be commited and tagged ${1}"
  echo
  read -p "Do you want to continue? " -n 1 -r
  echo

  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# if we have made it this far, we are ready to make changes
echo "Deploying version ${1}"

echo "Checking out development branch"
git checkout development

# ensure no local changes to openapi.yaml
git diff-index --quiet HEAD -- openapi.yaml

exit_status=$?
if [ $exit_status -ne 0 ]; then
  echo "Error: Local changes have been made to openapi.yaml."
  echo "       Please commit those changes before proceeding."
  exit 1
fi

echo "Creating a release branch release-${1}"
git checkout -b "release-${1}"
echo "Updating openapi.yaml with the new version number"
sed -ie -E -- "s|version: [0-9]+\.[0-9]+\.[0-9]|version: ${1}|" openapi.yaml
echo "Committing the version bump"
git add --all
git commit -m "Bump version to ${1}"
echo "Tagging the version commit with the version number"
git tag ${1}
